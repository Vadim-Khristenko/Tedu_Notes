---
import type { MarkdownHeading } from "astro";
import { i18n } from "astro:config/client";
import { getCollection, render } from "astro:content";
import Base from "$layouts/Base.astro";
import Icon from "$components/Icon.astro";
import TOC from "$components/note/TOC.astro";
import Sensitive from "$components/Sensitive.svelte";
import Position from "$components/Position.astro";
import Time from "$utils/time";
import i18nit from "$i18n";

export async function getStaticPaths() {
	const notes = await getCollection("note", (note) => !note.data.draft);

	return notes.map((note) => {
		const [language, ...id] = note.id.split("/");
		return {
			params: {
				locale: language === i18n?.defaultLocale ? undefined : language,
				id: id.join("/"),
			},
			props: { note },
		};
	});
}

const { locale = i18n!.defaultLocale } = Astro.params;
const { note } = Astro.props;
const t = i18nit(locale);

// Render markdown and extract headings
const { Content, headings, remarkPluginFrontmatter: frontmatter } = await render(note);

// Build nested TOC only if contents is enabled
const buildTOC = (raw: MarkdownHeading[]): any[] => {
	const tree: any[] = [];
	const stack: any[] = [];

	for (const h of raw) {
		while (stack.length && stack[stack.length - 1].depth >= h.depth) stack.pop();
		const node = { ...h, subheadings: [] as any[] };
		if (stack.length) {
			stack[stack.length - 1].subheadings.push(node);
		} else {
			tree.push(node);
		}
		stack.push(node);
	}

	return tree;
};

const hasContents = note.data.contents === true;
const table_of_contents: any[] = hasContents ? buildTOC(headings) : [];

// Title formatting
const formatTitle = (raw: unknown, split: boolean): string[] => {
	if (raw === undefined || raw === null) return [""];
	const s = String(raw);
	if (!split) return [s.replace(/<br\s*\/?>(\s*)|\n+/gi, " ").trim()];
	return s
		.replace(/<br\s*\/?>(\s*)/gi, "\n")
		.split(/\n+/)
		.map((l) => l.trim())
		.filter(Boolean);
};

const titleSplit = note.data.title_split !== false;
const titleLines = formatTitle(note.data.title, titleSplit);

// Dates
const published = note.data.timestamp;
const publishedHuman = Time(published);
const publishedFull = Time.full(published);

const lastUpdated = note.data.last_updated_timestamp
	? new Date(note.data.last_updated_timestamp)
	: undefined;
const lastUpdatedHuman = lastUpdated ? Time(lastUpdated) : undefined;
const lastUpdatedFull = lastUpdated ? Time.full(lastUpdated) : undefined;

// Breadcrumbs
let localePrefix = locale === i18n?.defaultLocale || locale === "ru" ? "" : `/${locale}`;
const realNoteId = typeof note.id === "string" ? note.id.replace(/^[^/]*\//, "") : String(note.id);

const breadcrumbs = [
	{ label: t("navigation.home"), href: `${localePrefix}/` },
	{ label: t("navigation.note"), href: `${localePrefix}/note` },
];
if (note.data.series) {
	breadcrumbs.push({
		label: note.data.series,
		href: `${localePrefix}/note?series=${encodeURIComponent(note.data.series)}`,
	});
}
breadcrumbs.push({ label: titleLines.join(" · "), href: "#" });

// Schema.org
const structuredData = {
	"@context": "https://schema.org",
	"@type": "Article",
	headline: note.data.title,
	description: note.data.description,
	author: { "@type": "Person", name: "Vadim Khristenko" },
	datePublished: published.toISOString(),
	dateModified: (lastUpdated ?? published).toISOString(),
	mainEntityOfPage: {
		"@type": "WebPage",
		"@id": `https://tedu-notes.ru${localePrefix}/note/${realNoteId}`,
	},
	publisher: {
		"@type": "Organization",
		name: "TEDU Notes",
		logo: { "@type": "ImageObject", url: "https://tedu-notes.ru/favicon.svg" },
	},
	articleSection: note.data.series || "Notes",
	keywords: (note.data.tags ?? []).join(", "),
	wordCount: frontmatter.words,
	timeRequired: `PT${Math.ceil(frontmatter.words / 200)}M`,
};
---

<Base
	title={note.data.title}
	{locale}
	description={note.data.description}
	article={{
		timestamp: published,
		last_updated_timestamp: lastUpdated,
		section: note.data.series,
		tags: note.data.tags,
		image: note.data.image,
		image_alt: note.data.image_alt,
	}}
>
	<script type="application/ld+json" set:html={JSON.stringify(structuredData)} is:inline />

	<main class="note-page">
		<nav aria-label="Breadcrumb" class="note-breadcrumbs">
			{breadcrumbs.map((crumb, index) => (
				<>
					{index > 0 && <Icon name="lucide:chevron-right" class="crumb-sep" />}
					{crumb.href === "#" ? (
						<span class="crumb crumb--current">{crumb.label}</span>
					) : (
						<a href={crumb.href} class="crumb">{crumb.label}</a>
					)}
				</>
			))}
		</nav>

		<header class={`note-hero-beta ${note.data.image ? "note-hero-beta--with-image" : "note-hero-beta--no-image"}`}>
			<div class="note-hero-beta__content">
				{note.data.series && (
					<div class="label-series">
						<Icon name="lucide:layers" />
						<span>{note.data.series}</span>
					</div>
				)}
			
				{note.data.image && (
					<div class="note-hero-beta__image-wrapper">
						<div class="note-hero-beta__image">
							<img
								src={note.data.image}
								alt={note.data.image_alt ?? note.data.title}
								loading="lazy"
								decoding="async"
							/>
						</div>
						{note.data.image_alt && (
							<figcaption class="note-hero-beta__image-caption">
								{note.data.image_alt}
							</figcaption>
						)}
					</div>
				)}


				<h1 class="note-title-beta" style={`font-family: var(--note-title-font);`}>
					{titleLines.map((line) => (
						<span class="title-line">{line}</span>
					))}
				</h1>

				{note.data.description && (
					<p class="note-subtitle-beta">{note.data.description}</p>
				)}

				<div class="note-meta-beta">
					<div class="note-meta-row note-meta-row--dates">
						{lastUpdated && (
							<time
								class="meta-pill meta-pill--soft"
								title={lastUpdatedFull}
							>
								<Icon name="lucide:refresh-ccw" />
								<span>{t("meta.updated", { text: lastUpdatedHuman! })}</span>
							</time>
						)}

						<time
							class="meta-pill"
							title={publishedFull}
							datetime={published.toISOString()}
						>
							<Icon name="lucide:calendar" />
							<span>{t("meta.created", { text: publishedHuman })}</span>
						</time>
					</div>

					{note.data.tags?.length && (
						<div class="note-meta-row note-meta-row--tags">
							{note.data.tags.map((tag) => (
								<span class="tag-pill">{tag}</span>
							))}
						</div>
					)}

					<div class="note-meta-row note-meta-row--extra">
						<div class="meta-pill meta-pill--soft">
							<Icon name="lucide:pilcrow" />
							<span>{t("read.words", { integer: frontmatter.words })}</span>
						</div>

						<div class="meta-pill meta-pill--ghost">
							<Icon name="lucide:clock" />
							<span>{Math.ceil(frontmatter.words / 200)} {t("read.minutes")}</span>
						</div>
					</div>
				</div>
			</div>
		</header>

		<Sensitive {locale} back="/note" sensitive={note.data.sensitive} client:load>
			<div class={`note-layout-beta ${hasContents && table_of_contents.length > 0 ? "note-layout-beta--with-toc" : "note-layout-beta--no-toc"}`}>
				<article class="note-main-beta markdown" id="markdown-content">
					<Content />
				</article>

				{hasContents && table_of_contents.length > 0 && (
					<aside class="note-toc-beta">
						<div class="note-toc-beta__inner">
							<div class="note-toc-beta__header">
								<h3>{t("note.contents")}</h3>
							</div>
							<nav class="note-toc-beta__nav">
								<TOC headings={table_of_contents} />
							</nav>
						</div>
					</aside>
				)}
			</div>
		</Sensitive>

		<div class="note-share-beta">
			<span class="note-share-beta__label">{t("share.title")}:</span>
			<a
				href={`https://x.com/intent/tweet?text=${encodeURIComponent(note.data.title)}&url=${encodeURIComponent(`https://tedu-notes.ru${localePrefix}/note/${realNoteId}`)}`}
				target="_blank"
				rel="noopener noreferrer"
				class="share-pill share-pill--x"
				aria-label={t("share.twitter")}
			>
				<Icon name="simple-icons:x" class="w-4 h-4" />
			</a>

			<a
				href={`https://t.me/share/url?url=${encodeURIComponent(`https://tedu-notes.ru${localePrefix}/note/${realNoteId}`)}&text=${encodeURIComponent(note.data.title)}`}
				target="_blank"
				rel="noopener noreferrer"
				class="share-pill share-pill--tg"
				aria-label={t("share.telegram")}
			>
				<Icon name="simple-icons:telegram" class="w-4 h-4" />
			</a>
		</div>

		<Position {locale} />
	</main>
</Base>

<script>
	document.addEventListener("click", (e) => {
		const target = e.target as HTMLElement | null;
		if (!target) return;
		if (target.matches('a[href^="#"]')) {
			const href = target.getAttribute("href");
			if (!href || href === "#") return;
			e.preventDefault();
			const id = href.slice(1);
			const el = document.getElementById(id);
			if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
		}
	});
</script>

<style>
.note-page {
	display: flex;
	flex-direction: column;
	gap: 1.75rem;
}

.note-breadcrumbs {
	display: flex;
	flex-wrap: wrap;
	align-items: center;
	gap: 0.25rem;
	font-size: 0.8rem;
	color: var(--remark-color);
}

.crumb {
	color: inherit;
	text-decoration: none;
	padding: 0.1rem 0.2rem;
	border-radius: 4px;
	transition: color 0.15s ease, background-color 0.15s ease;
}

.crumb:hover {
	color: var(--primary-color);
	background: color-mix(in srgb, var(--primary-color) 6%, transparent 94%);
}

.crumb--current {
	font-weight: 600;
	color: var(--primary-color);
}

.crumb-sep {
	width: 14px;
	height: 14px;
	color: color-mix(in srgb, var(--remark-color) 70%, transparent 30%);
}

.note-hero-beta {
	display: flex;
	flex-direction: column;
	gap: 1.5rem;
	padding: clamp(1.2rem, 3vw, 1.8rem);
	border-radius: 1.25rem;
	background:
		linear-gradient(
			135deg,
			color-mix(in oklab, var(--primary-color) 8%, transparent) 0%,
			transparent 40%
		),
		color-mix(in oklab, var(--background-color) 95%, var(--primary-color) 5%);
	box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
}

.note-hero-beta--with-image {
	gap: 1.5rem;
}

.note-hero-beta--no-image {
	gap: 0;
}

.note-hero-beta__content {
	display: flex;
	flex-direction: column;
	gap: 0.65rem;
}

.label-series {
	display: inline-flex;
	align-items: center;
	gap: 0.4rem;
	padding: 0.24rem 0.6rem;
	border-radius: 999px;
	background: color-mix(in oklab, var(--primary-color) 12%, transparent);
	color: var(--primary-color);
	font-size: 0.75rem;
	font-weight: 600;
}

.note-title-beta {
	margin: 0;
	font-size: clamp(1.9rem, 4.6vw, 3rem);
	line-height: 1.05;
}

.title-line {
	display: block;
}

.note-subtitle-beta {
	margin: 0.1rem 0 0;
	font-size: 0.96rem;
	color: var(--remark-color);
}

.note-meta-beta {
	margin-top: 0.4rem;
	display: flex;
	flex-direction: column;
	gap: 0.3rem;
}

.note-meta-row {
	display: flex;
	flex-wrap: wrap;
	gap: 0.4rem;
	align-items: center;
}

.meta-pill {
	display: inline-flex;
	align-items: center;
	gap: 0.35rem;
	padding: 0.26rem 0.6rem;
	border-radius: 999px;
	background: color-mix(in oklab, var(--background-color) 96%, var(--primary-color) 4%);
	border: 1px solid color-mix(in oklab, var(--primary-color) 16%, transparent);
	font-size: 0.78rem;
}

.meta-pill--soft {
	background: color-mix(in oklab, var(--primary-color) 10%, transparent);
	color: var(--secondary-color);
}

.meta-pill--ghost {
	background: transparent;
	border-style: dashed;
}

.meta-tags {
	display: flex;
	flex-wrap: wrap;
	gap: 0.3rem;
}

.tag-pill {
	padding: 0.18rem 0.5rem;
	border-radius: 999px;
	background: color-mix(in oklab, var(--primary-color) 7%, transparent);
	border: 1px solid color-mix(in oklab, var(--primary-color) 18%, transparent);
	font-size: 0.72rem;
}

.note-hero-beta__image {
	align-self: center;
	border-radius: 0.9rem;
	overflow: hidden;
	border: 1px solid color-mix(in oklab, var(--primary-color) 20%, transparent);
	background: radial-gradient(circle at top, rgba(255, 255, 255, 0.14), transparent);
}

.note-hero-beta__image img {
	width: 100%;
	max-height: 220px;
	object-fit: cover;
	display: block;
}

.note-hero-beta__image-wrapper {
	display: flex;
	flex-direction: column;
	gap: 0.4rem;
}

.note-hero-beta__image-caption {
	font-size: 0.8rem;
	color: var(--remark-color);
	font-style: italic;
	text-align: center;
	padding: 0 0.5rem;
}

.note-layout-beta {
	margin-top: 0.75rem;
	display: grid;
	gap: 1.5rem;
	align-items: flex-start;
}

/* С TOC две колонки, без TOC контент на всю ширину */
.note-layout-beta--with-toc {
	grid-template-columns: minmax(0, 2.3fr) minmax(220px, 1.2fr);
}

.note-layout-beta--no-toc {
	grid-template-columns: minmax(0, 1fr);
}

.note-main-beta {
	min-width: 0;
}

.note-toc-beta {
	min-width: 0;
}

.note-toc-beta__inner {
	position: sticky;
	top: 1rem;
	padding: 0.75rem 0.6rem 0.75rem 0.9rem;
	border-radius: 0.9rem;
	background: color-mix(in oklab, var(--background-color) 98%, var(--primary-color) 2%);
	border: 1px solid color-mix(in oklab, var(--primary-color) 16%, transparent);
	box-shadow: 0 8px 24px rgba(15, 23, 42, 0.05);
}

.note-toc-beta__header h3 {
	margin: 0 0 0.35rem;
	font-size: 0.86rem;
	font-weight: 600;
	color: var(--remark-color);
}

.note-toc-beta__nav {
	max-height: 70vh;
	overflow-y: auto;
	padding-right: 0.25rem;
}

.note-share-beta {
	margin-top: 0.5rem;
	display: flex;
	align-items: center;
	gap: 0.4rem;
	font-size: 0.8rem;
	color: var(--remark-color);
}

.note-share-beta__label {
	margin-right: 0.25rem;
}

.share-pill {
	width: 30px;
	height: 30px;
	border-radius: 999px;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	color: #ffffff;
	transition: transform 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease;
}

.share-pill--x {
	background: #111111;
}

.share-pill--tg {
	background: #26a5e4;
}

.share-pill:hover {
	transform: translateY(-1px);
	box-shadow: 0 6px 14px rgba(15, 23, 42, 0.18);
}

@media (max-width: 880px) {
	.note-hero-beta {
		grid-template-columns: minmax(0, 1fr);
	}

	.note-hero-beta__image-wrapper {
		width: 100%;
	}

	.note-layout-beta {
		grid-template-columns: minmax(0, 1fr);
	}

	.note-toc-beta {
		display: none;
	}
}
</style>
